title: ajax处理302跳转与内容协商
date: 2016-05-12
category: 技术
tags: [http]
---

随着各种前端框架的的蓬勃发展，单页面应用（`SPA`）无论在移动端的`webapp`/`Hybrid`，还是各种PC内部管理系统都有着他们独特的身影。这种无页面刷新切换页面的实现，借助于`ajax`的异步请求。
<!-- more -->
## ajax处理302

虽然`ajax`异步请求有着诸多的优势和方便，但是它也不是万能的，总有些地方是`ajax`的手无法触及的，就像服务器状态码`302 Found`，`ajax`的回调对这个服务器响应是透明的，不能直接进行跳转，而在同步请求中，浏览器自动跳转，那么问题来了，在一些情况下，我需要用`ajax`异步请求，但是此时`cookie/session`失效，必须进行跳转重新登录，而且即使不是单页应用，只要存在异步提交数据，都将面临这个问题。

解决办法：
    1、避免使用`ajax`提交，采用`form`表单提交；少数业务场景可行，多数情况是无法避免使用`ajax`
    2、急需后端配合：在需要进行302跳转的地方，后端统一返回200，在返回的`json`数据中使用特殊的错误状态码，以及对应需要跳转的url链接，前端根据特殊的错误码和`url`，用`location`进行跳转。

之前看到有人说直接可以在回调函数中，通过`XMLHttpRequest`对象的`status`值（`xhr.status == 302`）来进行判断并做跳转，但是这明显是不可行的。因为当服务器返回给浏览器`302`，浏览器并不是直接进行`ajax`回调处理，而是先去执行`302`重定向（从`response header`中读取`location`信息，再向`location`中的`url`进行请求，在收到这个请求的响应后，最后才对`ajax`回调做处理），流程如下：
`ajax -> browser -> server ->302 -> browser(redirect) -> server -> browser -> ajax callbacks`
在最后的`ajax`回调中获得的状态码可能是`404`，也有可能是`200`，原因是在`302`重定向后，浏览器对`location`中`url`进行请求，可能这个请求的`url`在系统中的确存在，此时返回的就是`200`，如果不存在，或请求失败，则可能是`404`了。

## 内容协商
什么事内容协商
> 一个资源可能会有多种不同的表现形式，比如，可能会有不同语言或者媒体类型的版本甚至其组合。最常用的选择方法是提供一个索引页以供选择。但是由于浏览器可以在请求头信息中提供其首选项的表现形式， 因此就有可能让服务器自动选择。

举个栗子：复杂的请求，浏览器表明，可以接受法语和英语，但最好是法语； 接受各种媒体类型，最好是HTML，纯文件或其他文本类型也可以； 最好是GIF或JPEG，其他媒体类型也可以，并允许其他媒体类型作为最终表现形式：
> Accept-Language: fr; q=1.0, en; q=0.5
Accept: text/html; q=1.0, text/*; q=0.8, image/gif; q=0.6, image/jpeg; q=0.6, image/*; q=0.5, */*; q=0.1

用简单的话来说，就是前端想后端给它提供什么资源，包括格式，类型等，通过在`request Header`中设置，服务端根据前端的请求报头，给前端返回恰当的数据，这是一个多么和谐的方式啊~

至于为何会在本文中提及，主要是一个应用中并不是所有的`ajax`请求都是你能完全控制的，例如利用第三方登录，`ajax`请求是第三方发出的，这时候需要进行跳转，结合文章前半部分的内容，如果这个登录跳转也交给前端来处理，那就gg了，因为这个请求根本就不是前端发出的，所以还得利用`302`跳转，这两者结合起来看，就是矛盾的了，所以内容协商的策略就能够派上用场了~
系统前端自身的请求中通过设置报头的`Accept`为`application/json, text/javascript, */*; q=0.01`，（例如`jquery`可以通过设置`dataType`为`json`），当需要`302`跳转时后端返回`json`数据给前端，由前端来完成跳转，而普通的请求一般为`text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8`，可以直接`302`重定向。
